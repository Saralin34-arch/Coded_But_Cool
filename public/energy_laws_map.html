<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>U.S. Building Energy Laws Map</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: transparent;
      font-family: "Courier New", Courier, monospace;
      padding: 24px;
      overflow: hidden;
    }

    .map-container {
      background: transparent;
      border-radius: 16px;
      padding: 16px;
      overflow: visible;
    }

    .map-wrapper {
      transform: none;
      transform-origin: center center;
      transition: transform 0.3s ease;
    }

    #map-svg {
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.15))
              drop-shadow(0 0 35px rgba(255, 255, 255, 0.1))
              drop-shadow(0 0 50px rgba(200, 210, 220, 0.08));
    }

    .state-label {
      font-family: "Caveat", "Comic Sans MS", cursive;
      font-size: 18px;
      fill: #1f2937;
      pointer-events: none;
      font-weight: 500;
    }


    #map-svg {
      display: block;
      width: 100%;
      height: auto;
    }

    .state {
      fill: #e5e7eb;
      stroke: #ffffff;
      stroke-width: 1;
      transition: all 0.3s ease;
    }

    .state.has-law {
      fill: #d1d5db;
      cursor: pointer;
    }

    .state.has-law:hover {
      fill: #9bb8d3;
      transform: translateY(-8px);
      filter: drop-shadow(0 12px 20px rgba(0, 0, 0, 0.25));
    }

    .tooltip {
      position: fixed;
      pointer-events: none;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      max-width: 320px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1000;
    }

    .tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip-city {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .tooltip-law {
      font-size: 1rem;
      color: #1f2937;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .tooltip-year {
      font-size: 0.8rem;
      color: #9bb8d3;
      margin-bottom: 8px;
    }

    .tooltip-summary {
      font-size: 0.8rem;
      color: #4b5563;
      line-height: 1.5;
    }

  </style>
</head>
<body>

<div class="map-container">
  <div class="map-wrapper">
    <svg id="map-svg" viewBox="0 0 960 600"></svg>
  </div>
  
</div>

<div class="tooltip" id="tooltip">
  <div class="tooltip-city" id="tooltip-city"></div>
  <div class="tooltip-law" id="tooltip-law"></div>
  <div class="tooltip-year" id="tooltip-year"></div>
  <div class="tooltip-summary" id="tooltip-summary"></div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

<script>
// Building energy laws dataset
const laws = [
  { state: "NY", city: "New York City", lawName: "Local Law 97", year: "2019",
    summary: "Carbon emissions caps for buildings >25,000 ft²; penalties begin mid-2020s." },
  { state: "IL", city: "Chicago", lawName: "Energy Use Benchmarking Ordinance", year: "2013",
    summary: "Large buildings must benchmark and disclose annual energy use." },
  { state: "CA", city: "Los Angeles", lawName: "EBEWE Ordinance", year: "2016–2017",
    summary: "Benchmarking + mandatory energy/water audits & retro-commissioning." },
  { state: "CA", city: "San Francisco", lawName: "Existing Commercial Buildings Energy Ordinance", year: "2011",
    summary: "Non-residential buildings ≥10,000 ft² must benchmark + complete 5-year audits." },
  { state: "MA", city: "Boston", lawName: "BERDO / BERDO 2.0", year: "2013 / 2021",
    summary: "Benchmarking + declining carbon-emission performance standards toward net-zero 2050." },
  { state: "WA", city: "Seattle", lawName: "Building Tune-Ups Ordinance", year: "2016",
    summary: "Periodic operational tune-ups for non-residential buildings." },
  { state: "FL", city: "Orlando", lawName: "BEWES", year: "2016",
    summary: "Benchmarking & efficiency reporting for large existing buildings." },
  { state: "TX", city: "Austin", lawName: "ECAD Ordinance", year: "2008–2009",
    summary: "Energy audits + disclosure for homes/buildings; benchmarking for large commercial." },
  { state: "TX", city: "Houston", lawName: "Municipal Building Decarbonization Policy", year: "2022",
    summary: "Benchmarking, audits & performance targets for city-owned buildings." },
  { state: "DC", city: "Washington, DC", lawName: "BEPS", year: "2018 / 2021",
    summary: "Building Energy Performance Standards with 6-year compliance cycles." }
];

// State FIPS to abbreviation mapping
const fipsToState = {
  "01": "AL", "02": "AK", "04": "AZ", "05": "AR", "06": "CA",
  "08": "CO", "09": "CT", "10": "DE", "11": "DC", "12": "FL",
  "13": "GA", "15": "HI", "16": "ID", "17": "IL", "18": "IN",
  "19": "IA", "20": "KS", "21": "KY", "22": "LA", "23": "ME",
  "24": "MD", "25": "MA", "26": "MI", "27": "MN", "28": "MS",
  "29": "MO", "30": "MT", "31": "NE", "32": "NV", "33": "NH",
  "34": "NJ", "35": "NM", "36": "NY", "37": "NC", "38": "ND",
  "39": "OH", "40": "OK", "41": "OR", "42": "PA", "44": "RI",
  "45": "SC", "46": "SD", "47": "TN", "48": "TX", "49": "UT",
  "50": "VT", "51": "VA", "53": "WA", "54": "WV", "55": "WI",
  "56": "WY", "72": "PR"
};

// Get states that have laws
const statesWithLaws = new Set(laws.map(l => l.state));

// Get laws for a state (may have multiple cities)
function getLawsForState(stateAbbr) {
  return laws.filter(l => l.state === stateAbbr);
}

// Setup SVG and projection
const svg = d3.select("#map-svg");
const width = 960;
const height = 600;

const projection = d3.geoAlbersUsa()
  .scale(1200)
  .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

// Tooltip elements
const tooltip = document.getElementById("tooltip");
const tooltipCity = document.getElementById("tooltip-city");
const tooltipLaw = document.getElementById("tooltip-law");
const tooltipYear = document.getElementById("tooltip-year");
const tooltipSummary = document.getElementById("tooltip-summary");

// Load and render the map
d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
  const states = topojson.feature(us, us.objects.states).features;

  // Render states
  svg.selectAll(".state")
    .data(states)
    .enter()
    .append("path")
    .attr("class", d => {
      const stateAbbr = fipsToState[d.id];
      return statesWithLaws.has(stateAbbr) ? "state has-law" : "state";
    })
    .attr("d", path)
    .attr("data-state", d => fipsToState[d.id])
    .on("mouseenter", function(event, d) {
      const stateAbbr = fipsToState[d.id];
      if (!statesWithLaws.has(stateAbbr)) return;

      const stateLaws = getLawsForState(stateAbbr);
      if (stateLaws.length === 0) return;

      // For states with multiple cities, show the first one
      // You could extend this to show all cities
      const law = stateLaws[0];
      
      // If multiple cities, append to city name
      let cityText = law.city;
      if (stateLaws.length > 1) {
        cityText = stateLaws.map(l => l.city).join(" • ");
      }

      tooltipCity.textContent = cityText;
      tooltipLaw.textContent = law.lawName;
      tooltipYear.textContent = `Enacted: ${law.year}`;
      tooltipSummary.textContent = law.summary;

      tooltip.classList.add("visible");
    })
    .on("mousemove", function(event) {
      const x = event.clientX + 16;
      const y = event.clientY + 16;
      
      // Keep tooltip within viewport
      const tooltipRect = tooltip.getBoundingClientRect();
      const maxX = window.innerWidth - tooltipRect.width - 20;
      const maxY = window.innerHeight - tooltipRect.height - 20;
      
      tooltip.style.left = Math.min(x, maxX) + "px";
      tooltip.style.top = Math.min(y, maxY) + "px";
    })
    .on("mouseleave", function() {
      tooltip.classList.remove("visible");
    });

  // Add state borders
  svg.append("path")
    .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
    .attr("class", "state-borders")
    .attr("fill", "none")
    .attr("stroke", "#ffffff")
    .attr("stroke-width", 1)
    .attr("d", path);

  // Add city/state labels
  const labelPositions = [
    { label: "SEATTLE", x: 120, y: 90 },
    { label: "CALIFORNIA", x: 80, y: 320 },
    { label: "TEXAS", x: 420, y: 450 },
    { label: "CHICAGO", x: 560, y: 258 },
    { label: "BOSTON", x: 820, y: 155 },
    { label: "NEW YORK", x: 780, y: 195 },
    { label: "FLORIDA", x: 720, y: 480 }
  ];

  svg.selectAll(".state-label")
    .data(labelPositions)
    .enter()
    .append("text")
    .attr("class", "state-label")
    .attr("x", d => d.x)
    .attr("y", d => d.y)
    .text(d => d.label);
});
</script>

</body>
</html>

